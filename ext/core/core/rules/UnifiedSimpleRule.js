// ext/core/rules/UnifiedSimpleRule.js
//
// –ü—Ä–∞–≤–∏–ª–æ "–ü—Ä–æ—Å—Ç–æ": –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –æ–¥–Ω–æ—à–∞–≥–æ–≤—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–∞,
// —Å—Ç—Ä–æ–≥–æ –ø–æ —Ñ–∏–∑–∏–∫–µ –∞–±–∞–∫—É—Å–∞.
//
// –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏:
//
// - –£ –Ω–∞—Å –µ—Å—Ç—å –æ–¥–Ω–∞ —Å—Ç–æ–π–∫–∞ –∞–±–∞–∫—É—Å–∞ (—Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ–º –≤ digitCount=1, –Ω–æ –∫–æ–¥
//   —É–∂–µ –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –ø–æ—Ç–æ–º –±—É–¥–µ—Ç –±–æ–ª—å—à–µ).
//
// - –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–æ–π–∫–∏ ‚Äî —ç—Ç–æ —á–∏—Å–ª–æ 0..9, –≥–¥–µ:
//     0..4  ‚Üí –∞–∫—Ç–∏–≤–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏–µ –±—É—Å–∏–Ω—ã (–ø–æ 1)
//     5..9  ‚Üí –∞–∫—Ç–∏–≤–Ω–∞ –≤–µ—Ä—Ö–Ω—è—è (5) + —á–∞—Å—Ç—å –Ω–∏–∂–Ω–∏—Ö
//
//   –ü—Ä–∏–º–µ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å–∏–Ω:
//     0 ‚Üí (–Ω–∏—á–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ)
//     3 ‚Üí (—Ç—Ä–∏ –Ω–∏–∂–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã)
//     5 ‚Üí (—Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ö–Ω—è—è –∞–∫—Ç–∏–≤–Ω–∞)
//     7 ‚Üí (–≤–µ—Ä—Ö–Ω—è—è + –¥–≤–µ –Ω–∏–∂–Ω–∏–µ)
//     9 ‚Üí (–≤–µ—Ä—Ö–Ω—è—è + —á–µ—Ç—ã—Ä–µ –Ω–∏–∂–Ω–∏–µ)
//
// - –û–¥–∏–Ω –ñ–ï–°–¢ (action) ‚Äî —ç—Ç–æ –æ–¥–Ω–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Ä—É–∫–∏ —Ä–µ–±—ë–Ω–∫–∞ –≤ —Ä–∞–º–∫–∞—Ö –±–ª–æ–∫–∞ "–ü—Ä–æ—Å—Ç–æ":
//     ‚Ä¢ –≤–≤–µ—Ä—Ö (–¥–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç–æ–π–∫–µ),
//     ‚Ä¢ –≤–Ω–∏–∑ (—Å–Ω–∏–º–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ —Å—Ç–æ–π–∫–∏).
//
//   –ñ–µ—Å—Ç –º–æ–∂–µ—Ç:
//   - –ø–æ–¥–Ω—è—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏—Ö –±—É—Å–∏–Ω –∑–∞ —Ä–∞–∑ (+1..+4),
//   - –æ–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏—Ö –±—É—Å–∏–Ω –∑–∞ —Ä–∞–∑ (-1..-4),
//   - –ø–æ–¥–Ω—è—Ç—å –∏–ª–∏ –æ–ø—É—Å—Ç–∏—Ç—å –≤–µ—Ä—Ö–Ω—é—é –±—É—Å–∏–Ω—É (+5 / -5),
//   - –ø–æ–¥–Ω—è—Ç—å –∏–ª–∏ –æ–ø—É—Å—Ç–∏—Ç—å –≤–µ—Ä—Ö–Ω—é—é –ò —Å—Ä–∞–∑—É k –Ω–∏–∂–Ω–∏—Ö (+6..+9 / -6..-9).
//
//   –ù–æ –∂–µ—Å—Ç –ù–ï –º–æ–∂–µ—Ç:
//   - –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á—Ç–æ-—Ç–æ –ø–æ–¥–Ω—è—Ç—å –∏ —á—Ç–æ-—Ç–æ –æ–ø—É—Å—Ç–∏—Ç—å,
//   - –¥–µ–ª–∞—Ç—å "–ø–µ—Ä–µ–Ω–æ—Å" —á–µ—Ä–µ–∑ —Å–ª–æ–∂–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Ç–∏–ø–∞ +4 –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –≤ 9),
//   - –≤—ã–¥—É–º—ã–≤–∞—Ç—å 8 –∫–∞–∫ "+4, –ø–æ—Ç–æ–º –µ—â—ë –¥–≤–∏–∂–µ–Ω–∏–µ" ‚Äî —ç—Ç–æ —É–∂–µ 2 –∂–µ—Å—Ç–∞, –Ω–µ 1.
//
// - –ü–µ—Ä–≤—ã–π —à–∞–≥ –≤ –ø—Ä–∏–º–µ—Ä–µ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º (–º—ã –Ω–µ –º–æ–∂–µ–º –Ω–∞—á–∞—Ç—å —Å –º–∏–Ω—É—Å–∞ –∏–∑ 0).
//
// - –ú—ã —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ –º–æ–¥—É–ª—é —à–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–±—Ä–∞–Ω—ã –≤ –±–ª–æ–∫–µ "–ü—Ä–æ—Å—Ç–æ".
//   –¢–æ –µ—Å—Ç—å –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —Ç–æ–ª—å–∫–æ [4], —Ç–æ –≤–µ—Å—å –ø—Ä–∏–º–µ—Ä –±—É–¥–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ +4/-4
//   –∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤, –≥–¥–µ +4 –∏ -4 —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
//   –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —Ç–æ–ª—å–∫–æ [7], —Ç–æ —É —Ä–µ–±—ë–Ω–∫–∞ –±—É–¥—É—Ç —à–∞–≥–∏ +7/-7 –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.
//
// - –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã —Ü–∏—Ñ—Ä—ã >=5, —Ç–æ —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –Ω–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
//   —Ç—Ä–æ–≥–∞—Ç—å –≤–µ—Ä—Ö–Ω—é—é –±—É—Å–∏–Ω—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–±—è–∑–∞–Ω –æ—Ç–¥–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞—Ç—å "5".
//   –ë–µ–∑ –≤–µ—Ä—Ö–Ω–µ–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å 6,7,8,9 –≤–æ–æ–±—â–µ. –≠—Ç–æ –º—ã —á–∏–Ω–∏–º —Ç—É—Ç.


import { BaseRule } from "./BaseRule.js";

export class UnifiedSimpleRule extends BaseRule {
  constructor(config = {}) {
    super(config);

    // (1) –ö–∞–∫–∏–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤ –±–ª–æ–∫–µ "–ü—Ä–æ—Å—Ç–æ"
    // –ù–∞–ø—Ä–∏–º–µ—Ä [1,2,3,4] –∏–ª–∏ [6] –∏–ª–∏ [2,7,9] –∏ —Ç.–¥.
    const selectedDigitsRaw = config.selectedDigits || [1, 2, 3, 4];
    // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —á–∏—Å–ª–∞
    const selectedDigits = Array.from(
      new Set(
        selectedDigitsRaw
          .map(n => parseInt(n, 10))
          .filter(n => Number.isFinite(n) && n >= 1 && n <= 9)
      )
    ).sort((a, b) => a - b);

    // (2) –ù—É–∂–Ω–∞ –ª–∏ –≤–µ—Ä—Ö–Ω—è—è –±—É—Å–∏–Ω–∞
    // –ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å 5..9, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç,
    // —á—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Ä–µ–±—ë–Ω–æ–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≤–µ—Ä—Ö–Ω–µ–π –±—É—Å–∏–Ω–æ–π.
    // –ó–Ω–∞—á–∏—Ç –º—ã –æ–±—è–∑–∞–Ω—ã —Ä–∞–∑—Ä–µ—à–∞—Ç—å –µ—ë —Ç—Ä–æ–≥–∞—Ç—å.
    const needsTopBead = selectedDigits.some(d => d >= 5);

    // (3) includeFive:
    //   - –µ—Å–ª–∏ needsTopBead === true ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ true;
    //   - –∏–Ω–∞—á–µ —É–≤–∞–∂–∞–µ–º —Ç–æ, —á—Ç–æ –ø—Ä–∏—à–ª–æ –∏–∑–≤–Ω–µ (UI/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏).
    const includeFive =
      needsTopBead ||
      (config.includeFive ??
        config.blocks?.simple?.includeFive ??
        selectedDigits.includes(5)) === true;

    this.name = "–ü—Ä–æ—Å—Ç–æ";
    this.description =
      "–û–¥–Ω–æ—Ä–∞–∑—Ä—è–¥–Ω—ã–µ —à–∞–≥–∏ –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–∞. –ö–∞–∂–¥—ã–π —à–∞–≥ = –æ–¥–∏–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∂–µ—Å—Ç.";

    this.config = {
      ...this.config,  // üî• –£–õ–£–ß–®–ï–ù–ò–ï: –Ω–∞—Å–ª–µ–¥—É–µ–º config –æ—Ç BaseRule
      // —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–µ–ª—ã:
      minState: 0,
      maxState: 9,

      // –¥–ª–∏–Ω–∞ —Ü–µ–ø–æ—á–∫–∏
      minSteps: config.minSteps ?? 2,
      maxSteps: config.maxSteps ?? 6,

      // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã —Ä–µ–±—ë–Ω–∫–æ–º (–∫–∞–∫–∏–µ —à–∞–≥–∏ –ø–æ –º–æ–¥—É–ª—é —Ä–∞–∑—Ä–µ—à–µ–Ω—ã)
      selectedDigits,
      includeFive,
      hasFive: includeFive, // —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –Ω–µ –ø–∞–¥–∞–ª

      // –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
      firstActionMustBePositive: true,
      onlyAddition: config.onlyAddition ?? false,
      onlySubtraction: config.onlySubtraction ?? false,

      // –º–Ω–æ–≥–æ—Ä–∞–∑—Ä—è–¥–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
      digitCount: config.digitCount ?? 1,
      combineLevels: config.combineLevels ?? false,

      // –±—É–¥–µ–º –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å —Ñ–ª–∞–≥–∏ –±—É–¥—É—â–∏—Ö —Ä–µ–∂–∏–º–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª –∫–æ–¥
      brothersActive: config.brothersActive ?? false,
      friendsActive: config.friendsActive ?? false,
      mixActive: config.mixActive ?? false,

      // –±–ª–æ–∫–∏ (—á—Ç–æ–±—ã –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–º–æ—Ç—Ä–µ—Ç—å)
      blocks: config.blocks ?? {}
      
      // üî• –£–ë–†–ê–õ–ò: ...config –≤ –∫–æ–Ω—Ü–µ - —Ç–µ–ø–µ—Ä—å –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ
    };

    console.log(
      `‚úÖ UnifiedSimpleRule –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:
  digitsAllowed=[${selectedDigits.join(", ")}]
  includeFive=${includeFive}
  digitCount=${this.config.digitCount}
  minSteps=${this.config.minSteps}
  maxSteps=${this.config.maxSteps}
  onlyAddition=${this.config.onlyAddition}
  onlySubtraction=${this.config.onlySubtraction}
  firstActionMustBePositive=${this.config.firstActionMustBePositive}`
    );
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
   * –î–ª—è "–ü—Ä–æ—Å—Ç–æ" (–æ–¥–∏–Ω —Å—Ç–æ–ª–±–µ—Ü) ‚Äî –≤—Å–µ–≥–¥–∞ 0.
   * –î–ª—è –±—É–¥—É—â–∏—Ö –º–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã—Ö ‚Äî –º–∞—Å—Å–∏–≤ –Ω—É–ª–µ–π.
   */
  generateStartState() {
    const dc = this.config.digitCount || 1;
    if (dc === 1) {
      return 0;
    }
    return Array(dc).fill(0);
  }

  /**
   * –°–ª—É—á–∞–π–Ω–∞—è –¥–ª–∏–Ω–∞ —Ü–µ–ø–æ—á–∫–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö [minSteps..maxSteps].
   */
  generateStepsCount() {
    const min = this.config.minSteps ?? 2;
    const max = this.config.maxSteps ?? min;
    if (min === max) return min;
    return min + Math.floor(Math.random() * (max - min + 1));
  }

  /**
   * –§–æ—Ä–º–∞—Ç –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä "+3" –∏–ª–∏ "-7").
   * –ï—Å–ª–∏ –ø–æ—Ç–æ–º –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ä–∞–∑—Ä—è–¥–∞–º–∏ –∏ –≤–µ–∫—Ç–æ—Ä–æ–º {position,value},
   * —Ç–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º value.
   */
  formatAction(action) {
    if (typeof action === "object" && action !== null) {
      // –º–Ω–æ–≥–æ—Ä–∞–∑—Ä—è–¥–Ω—ã–π —Å–ª—É—á–∞–π: { position, value }
      const v = action.value;
      return v >= 0 ? `+${v}` : `${v}`;
    }
    // –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ä–∞–∑—Ä—è–¥ (—á–∏—Å–ª–æ)
    return action >= 0 ? `+${action}` : `${action}`;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É –Ω–∞—Å –æ–¥–∏–Ω —Å—Ç–æ–ª–±–µ—Ü).
   */
  getDigitValue(state, position = 0) {
    if (Array.isArray(state)) {
      return state[position] ?? 0;
    }
    return state ?? 0;
  }

  /**
   * –ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–≥ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é.
   * - –ï—Å–ª–∏ action —ç—Ç–æ —á–∏—Å–ª–æ ‚Üí –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–∂–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –æ–¥–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞.
   * - –ï—Å–ª–∏ action —ç—Ç–æ {position,value} ‚Üí –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤ –º–∞—Å—Å–∏–≤–µ.
   */
  applyAction(currentState, action) {
    if (typeof action === "object" && action !== null) {
      const arr = Array.isArray(currentState)
        ? [...currentState]
        : [currentState];
      const { position, value } = action;
      arr[position] = (arr[position] ?? 0) + value;
      return arr;
    } else {
      // –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ä–∞–∑—Ä—è–¥
      const v = this.getDigitValue(currentState, 0);
      return v + action;
    }
  }

  /**
   * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—á–∏—Å–ª–æ –∏–ª–∏ –º–∞—Å—Å–∏–≤) –≤ –æ–¥–Ω–æ —á–∏—Å–ª–æ.
   * –î–ª—è –º–∞—Å—Å–∏–≤–∞ [–µ–¥–∏–Ω–∏—Ü—ã, –¥–µ—Å—è—Ç–∫–∏, —Å–æ—Ç–Ω–∏] ‚Üí —Å–∫–ª–µ–∏–≤–∞–µ–º –∫–∞–∫ –¥–µ—Å—è—Ç–∫–∏:
   *   [3,2,1] ‚Üí 123.
   */
  stateToNumber(state) {
    if (Array.isArray(state)) {
      // –ø–æ–∑–∏—Ü–∏—è 0 ‚Üí –µ–¥–∏–Ω–∏—Ü—ã, 1 ‚Üí –¥–µ—Å—è—Ç–∫–∏, ...
      return state.reduce(
        (sum, digit, idx) => sum + digit * Math.pow(10, idx),
        0
      );
    }
    return state ?? 0;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤–∞–ª–∏–¥–Ω–æ –ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≤—Å–µ —Ä–∞–∑—Ä—è–¥—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 0..9).
   */
  isValidState(state) {
    const { minState, maxState } = this.config;
    if (Array.isArray(state)) {
      return state.every(
        v => v >= minState && v <= maxState
      );
    }
    return state >= minState && state <= maxState;
  }

  /**
   * === –°–ï–†–î–¶–ï –õ–û–ì–ò–ö–ò ===
   *
   * –ù–∞ –æ—Å–Ω–æ–≤–µ –¢–ï–ö–£–©–ï–ì–û —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–æ–π–∫–∏ (v) –∏ –ø—Ä–∞–≤–∏–ª,
   * –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –î–ï–ô–°–¢–í–ò–ô (—à–∞–≥–æ–≤) –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ú–û–ñ–ï–ú —Å–µ–π—á–∞—Å —Å–¥–µ–ª–∞—Ç—å
   * –æ–¥–Ω–∏–º –∂–µ—Å—Ç–æ–º.
   *
   * –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–µ–π—Å—Ç–≤–∏–π:
   *   - –≤ –æ–¥–Ω–æ—Ä–∞–∑—Ä—è–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ: —á–∏—Å–ª–∞ [+3, -2, +7, ...]
   *   - –≤ –º–Ω–æ–≥–æ—Ä–∞–∑—Ä—è–¥–Ω–æ–º –±—É–¥—É—â–µ–º: –æ–±—ä–µ–∫—Ç—ã –≤–∏–¥–∞ { position, value }
   *
   * –ê–ª–≥–æ—Ä–∏—Ç–º:
   *   1. –ë–µ—Ä—ë–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ v (0..9).
   *   2. –ò–¥—ë–º –ø–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–º —Ü–µ–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º v2 (0..9).
   *   3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–¥–Ω–æ-–∂–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥ v -> v2.
   *      (isOneGestureTransition)
   *   4. –ï—Å–ª–∏ –¥–∞, —Å—á–∏—Ç–∞–µ–º delta = v2 - v.
   *   5. –†–∞–∑—Ä–µ—à–∞–µ–º delta, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ |delta| ‚àà selectedDigits,
   *      –∏ delta —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç –º–µ—Ç–æ–¥–∏–∫–µ:
   *        - –ø–µ—Ä–≤—ã–π —à–∞–≥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º,
   *        - –µ—Å–ª–∏ onlyAddition ‚Üí —Ç–æ–ª—å–∫–æ –ø–ª—é—Å—ã,
   *        - –µ—Å–ª–∏ onlySubtraction ‚Üí —Ç–æ–ª—å–∫–æ –º–∏–Ω—É—Å—ã (–∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞, –≥–¥–µ –º–∏–Ω—É—Å –∑–∞–ø—Ä–µ—â—ë–Ω).
   */
  getAvailableActions(currentState, isFirstAction = false, position = 0) {
    const {
      digitCount,
      selectedDigits,
      onlyAddition,
      onlySubtraction
    } = this.config;

    const v = this.getDigitValue(currentState, position); // —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —Å—Ç–æ–ª–±—Ü–µ
    const out = [];

    // –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –±—É–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (0..9)
    for (let v2 = 0; v2 <= 9; v2++) {
      const delta = v2 - v;
      if (delta === 0) continue; // "–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º" –Ω–µ —Å—á–∏—Ç–∞–µ–º —à–∞–≥–æ–º

      const dir = delta > 0 ? "up" : "down";
      const ok = this.isOneGestureTransition(v, v2, dir);
      if (!ok) continue;

      // —Å–∞–º –º–æ–¥—É–ª—å –¥–µ–ª—å—Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à—ë–Ω –≤ –±–ª–æ–∫–µ "–ü—Ä–æ—Å—Ç–æ"
      const absDelta = Math.abs(delta);
      if (!selectedDigits.includes(absDelta)) {
        continue;
      }

      // –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
      // 1) –ø–µ—Ä–≤—ã–π —à–∞–≥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∏–Ω—É—Å–æ–º
      if (isFirstAction && delta < 0) {
        continue;
      }

      // 2) —Ä–µ–∂–∏–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–∂–µ–Ω–∏–µ / —Ç–æ–ª—å–∫–æ –≤—ã—á–∏—Ç–∞–Ω–∏–µ
      if (onlyAddition && delta < 0) {
        continue;
      }
      if (onlySubtraction && delta > 0) {
        // –Ω–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —à–∞–≥, –º—ã –¢–û–õ–¨–ö–û –ß–¢–û –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –º–∏–Ω—É—Å –≤—ã—à–µ,
        // –∑–Ω–∞—á–∏—Ç —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ continue
        continue;
      }

      // —Ñ–æ—Ä–º–∏—Ä—É–µ–º —à–∞–≥
      if (digitCount > 1) {
        out.push({ position, value: delta });
      } else {
        out.push(delta);
      }
    }

    // –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    const stateStr = Array.isArray(currentState)
      ? `[${currentState.join(", ")}]`
      : currentState;
    console.log(
      `‚öôÔ∏è getAvailableActions(): state=${stateStr}, pos=${position}, v=${v} ‚Üí [${out
        .map(a => (typeof a === "object" ? a.value : a))
        .join(", ")}]`
    );

    return out;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ–º –ª–∏ –º—ã —Å–¥–µ–ª–∞—Ç—å –ü–†–Ø–ú–û–ô –æ–¥–Ω–æ-–∂–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Å–æ —Å—Ç–æ–π–∫–∏
   * –∏–∑ –∑–Ω–∞—á–µ–Ω–∏—è v –≤ –∑–Ω–∞—á–µ–Ω–∏–µ v2, —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º dir ("up" –∏–ª–∏ "down").
   *
   * –§–∏–∑–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å:
   *   - –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–µ—Ä—Ö–Ω–µ–π –±—É—Å–∏–Ω—ã = 5.
   *   - –ö–æ–ª-–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∏–∂–Ω–∏—Ö –±—É—Å–∏–Ω = v % 5, –Ω–æ:
   *        –µ—Å–ª–∏ v < 5 ‚Üí –≤–µ—Ä—Ö–Ω—è—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –Ω–∏–∂–Ω–∏–µ = v
   *        –µ—Å–ª–∏ v >= 5 ‚Üí –≤–µ—Ä—Ö–Ω—è—è –∞–∫—Ç–∏–≤–Ω–∞, –Ω–∏–∂–Ω–∏–µ = v-5
   *
   * –ñ–µ—Å—Ç "–≤–≤–µ—Ä—Ö":
   *   - –º—ã –ú–ê–°–°–û–í–û –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏—Ö –±—É—Å–∏–Ω –ò/–ò–õ–ò –≤–µ—Ä—Ö–Ω—é—é,
   *   - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º.
   *
   * –ñ–µ—Å—Ç "–≤–Ω–∏–∑":
   *   - –º—ã –ú–ê–°–°–û–í–û –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏—Ö –±—É—Å–∏–Ω –ò/–ò–õ–ò –≤–µ—Ä—Ö–Ω—é—é,
   *   - –Ω–∏—á–µ–≥–æ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º.
   *
   * –ñ–µ—Å—Ç –ù–ï –º–æ–∂–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á—Ç–æ-—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏ —á—Ç–æ-—Ç–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å.
   */
  isOneGestureTransition(v, v2, dir) {
    // –±—ã—Å—Ç—Ä–æ–µ –æ—Ç—Å–µ–∏–≤–∞–Ω–∏–µ
    if (v2 < 0 || v2 > 9) return false;
    if (dir === "up" && v2 <= v) return false;
    if (dir === "down" && v2 >= v) return false;

    // —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ v –≤–æ "–≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –≤–µ—Ä—Ö–Ω—è—è" –∏ "—Å–∫–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏—Ö –≤–∫–ª—é—á–µ–Ω–æ"
    const wasTop = v >= 5;
    const wasBot = wasTop ? (v - 5) : v; // 0..4

    const isTop = v2 >= 5;
    const isBot = isTop ? (v2 - 5) : v2; // 0..4

    // –≤—ã—á–∏—Å–ª–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –≤–µ—Ä—Ö–Ω–µ–π –±—É—Å–∏–Ω–µ –∏ –ø–æ –Ω–∏–∂–Ω–∏–º
    const topChange = (isTop ? 1 : 0) - (wasTop ? 1 : 0);    // -1,0,+1
    const botChange = isBot - wasBot;                        // -4..+4

    // –∂–µ—Å—Ç –≤–≤–µ—Ä—Ö:
    //   –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å (topChange >=0, botChange >=0),
    //   —Ö–æ—Ç—è –±—ã —á—Ç–æ-—Ç–æ –¥–æ–ª–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å—Å—è
    if (dir === "up") {
      if (topChange < 0) return false;
      if (botChange < 0) return false;
      if (topChange === 0 && botChange === 0) return false; // –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è
      return true;
    }

    // –∂–µ—Å—Ç –≤–Ω–∏–∑:
    //   –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–Ω–∏–º–∞—Ç—å (topChange <=0, botChange <=0),
    //   —Ö–æ—Ç—è –±—ã —á—Ç–æ-—Ç–æ –¥–æ–ª–∂–Ω–æ —Å–Ω—è—Ç—å—Å—è
    if (dir === "down") {
      if (topChange > 0) return false;
      if (botChange > 0) return false;
      if (topChange === 0 && botChange === 0) return false; // –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è
      return true;
    }

    return false;
  }

  /**
   * –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞.
   * –£—Å–ª–æ–≤–∏—è:
   *  1. –º—ã —Å—Ç–∞—Ä—Ç—É–µ–º –∏–∑ 0 (–∏–ª–∏ [0,...]).
   *  2. –ø–µ—Ä–≤—ã–π —à–∞–≥ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π.
   *  3. –∫–∞–∂–¥–æ–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ (0..9 –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–∞–∑—Ä—è–¥—É).
   *  4. –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à–∞–≥–æ–≤ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ answer.
   *  5. –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞ —Ñ–∏–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–∏–±–æ 0,
   *     –ª–∏–±–æ –æ–¥–Ω–æ–π –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ü–∏—Ñ—Ä (—ç—Ç–æ –Ω–∞—à –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∏–¥–æ—Ä).
   */
  validateExample(example) {
    const { start, steps, answer } = example;
    const {
      digitCount,
      selectedDigits,
      minState,
      maxState
    } = this.config;

    // 1. —Å—Ç–∞—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0
    const startNum = this.stateToNumber(start);
    if (startNum !== 0) {
      console.error(`‚ùå –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${startNum} ‚â† 0`);
      return false;
    }

    // 2. –ø–µ—Ä–≤—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
    if (steps.length > 0) {
      const firstActionRaw = steps[0].action;
      const firstVal =
        typeof firstActionRaw === "object"
          ? firstActionRaw.value
          : firstActionRaw;
      if (firstVal <= 0) {
        console.error(
          `‚ùå –ü–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ${firstVal} –Ω–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ`
        );
        return false;
      }
    }

    // 3. –≤—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã
    for (const step of steps) {
      if (!this.isValidState(step.toState)) {
        const stateStr = Array.isArray(step.toState)
          ? `[${step.toState.join(", ")}]`
          : step.toState;
        console.error(
          `‚ùå –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${stateStr} (–≤–Ω–µ ${minState}..${maxState})`
        );
        return false;
      }
    }

    // 4. –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫—É —Ü–µ–ª–∏–∫–æ–º
    let calcState = start;
    for (const step of steps) {
      calcState = this.applyAction(calcState, step.action);
    }
    const calcNum = this.stateToNumber(calcState);
    const answerNum = this.stateToNumber(answer);

    if (calcNum !== answerNum) {
      console.error(
        `‚ùå –ü–µ—Ä–µ—Å—á—ë—Ç –¥–∞–ª ${calcNum}, –∞ answer=${answerNum}`
      );
      return false;
    }

    // 5. –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–π —Ñ–∏–Ω–∞–ª
    if (digitCount === 1) {
      const allowedFinals = new Set([0, ...selectedDigits]);
      if (!allowedFinals.has(answerNum)) {
        console.error(
          `‚ùå –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ${answerNum} –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ {0, ${selectedDigits.join(
            ", "
          )}}`
        );
        return false;
      }
    } else {
      // –±—É–¥—É—â–∏–π –º–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã–π —Ä–µ–∂–∏–º: –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
      if (!this.isValidState(answer)) {
        console.error(
          `‚ùå –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${JSON.stringify(
            answer
          )} –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã ${minState}..${maxState}`
        );
        return false;
      }
    }

    console.log(
      `‚úÖ –ü—Ä–∏–º–µ—Ä –≤–∞–ª–∏–¥–µ–Ω (${this.name}): —Ñ–∏–Ω–∞–ª=${answerNum}`
    );
    return true;
  }
}
